async function updateUserData(e,t=!0){iLoup++;try{const r=ref(db,"users/"+e.uid);await get(r).then(async n=>{const s=n.exists();if(s){const{lastLogin:e,paid:t,status:s,...o}=n.val();for(const e in o)localStorage[e]=o[e];await update(r,{lastLogin:(new Date).toISOString(),status:"online"}).then(()=>{console.log("تم التسجيل وتعديل البيانات ✔️")})}else t?setTimeout(async()=>{iLoup<3?(await updateUserData(e),console.log("rah ydor : "+iLoup)):alert("حدث خطأ أعد المحاولة ✔️")},2e3):await setData(r,e)});let n=e.photoURL;if("https://pricealerts.web.app/imgs/web/icon-512-maskable.png"==n)localStorage.setItem("base64Pctr",n);else{console.log("img url is : "+n);let t=localStorage.userPicture;const r=n.lastIndexOf("=")+1,s=-1!==r?n.substring(0,r)+"s300-c":n;"frbsStrg"==t?await storgImg(e):await gogleImg(s)}window.location.href=drction}catch(e){console.log("error updateUserData is : "+e)}}async function setData(e,t){const r={userEmail:t.email,userName:t.displayName,userPicture:"noFrbsStrg",chtId1:"",chtId2:"",chtId3:"",paid:!1,lastLogin:(new Date).toISOString(),status:"online"};await set(e,r).then(()=>{for(const e in r)localStorage[e]=r[e];console.log("تم  إنشاء البيانات ✔️")})}async function sgnOUt(e){const t=ref(db,"users/"+e.uid);await update(t,{lastLogout:(new Date).toISOString(),status:"outline"}).then(()=>{console.log("تم  تعديل البيانات للخروج✔️")}),await signOut(auth).then(async()=>{console.log("تم تسجيل الخروج بنجاح"),localStorage.clear()}).catch(e=>{console.error("خطأ في تسجيل الخروج:",e)})}async function gogleImg(e){try{const t=new Image;t.crossOrigin="anonymous";const r=await new Promise((r,n)=>{t.onload=function(){const e=document.createElement("canvas"),n=e.getContext("2d");e.width=t.naturalWidth,e.height=t.naturalHeight,n.drawImage(t,0,0);const s=e.toDataURL("image/png");r(s)},t.onerror=function(){n("فشل تحميل الصورة")},t.src=e});localStorage.setItem("base64Pctr",r),console.log("تم حفظ الصورة بنجاح  في locale storg✔️")}catch(e){console.error(e)}}async function loadImageViaPost(e){try{const t="https://imageproxypost-wgqzo7cltq-ew.a.run.app",r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"gtImage",idImg:e})});if(console.log("respons is :"+r),!r.ok)throw new Error("فشل جلب الصورة");const n=await r.blob(),s=new Image;s.onload=(()=>{const e=document.createElement("canvas"),t=e.getContext("2d");e.width=s.naturalWidth,e.height=s.naturalHeight,t.drawImage(s,0,0),localStorage.setItem("base64Pctr",e.toDataURL("image/png")),URL.revokeObjectURL(s.src),console.log("تم حفظ الصورة بنجاح ✔️")}),s.onerror=(()=>{console.error("فشل تحميل الصورة داخل المتصفح")}),s.src=URL.createObjectURL(n)}catch(e){console.error("خطأ:",e.message)}}async function getAvatarBase64(e){try{const t=storageRef(storage,`avatars/${e}`),r=await getDownloadURL(t),n=await fetch(r),s=await n.blob();return await new Promise((e,t)=>{const r=new FileReader;r.onloadend=(()=>e(r.result)),r.onerror=t,r.readAsDataURL(s)})}catch(e){return console.error("خطأ في جلب الصورة:",e),null}}async function storgImg(e){if(!e)return;const t=storageRef(storage,`avatars/${e.uid}`);try{const e=await getDownloadURL(t),r=document.getElementById("avatarImg");r.crossOrigin="anonymous",r.src=e,r.onload=(()=>{const e=document.createElement("canvas");e.width=r.width,e.height=r.height;const t=e.getContext("2d");t.drawImage(r,0,0);const n=e.toDataURL("image/png");localStorage.setItem("base64Pctr",n);const s=document.createElement("img");s.src=n,document.body.appendChild(s)})}catch(e){console.error("حدث خطأ في جلب الصورة:",e)}}async function sgnIn(e){gebi(e).innerText="جاري التسجيل...",gebi(e).style.color="black";try{const t=await signInWithEmailAndPassword(auth,userEmail,userPassword);await updateUserData(t.user),userPassword=""}catch(t){"auth/invalid-credential"!==t.code&&"auth/wrong-password"!==t.code&&"auth/user-not-found"!==t.code||(gebi(e).innerText="كلمة السر أو الإيميل خاطئ، يرجى التأكد من الحساب",gebi(e).style.color="red"),console.log("err sgnIn is:"),console.log(t)}}async function adedUser(){const e=gebi("codeCnfrm").value;if(e.length<6||!Number(e))return gebi("errmsgCnfrm").innerText="رمز التحقق خاطئ أعد المحاولة",gebi("errmsgCnfrm").style.color="red",!1;gebi("errmsgCnfrm").innerText="جاري التحقق ...",gebi("errmsgCnfrm").style.color="black";const t={action:"addAccont",userName:userName,userEmail:userEmail,userPassword:userPassword,inputCode:e,signUp:!0},r=await ftchFirebase(t);"success"==r.status?await sgnIn("errmsgCnfrm"):"overNmber"==r.status?(gebi("errmsgCnfrm").innerText="عدد المحاولات أكثر من اللازم أعد المحاولة بعد ساعة",gebi("errmsgCnfrm").style.color="red"):"notExist"==r.status&&(gebi("errmsgCnfrm").innerText=" رمز التحقق خاطئ أعد المحاولة",gebi("errmsgCnfrm").style.color="red")}async function ftchFirebase(e){try{const t="https://europe-west1-pricealert-31787.cloudfunctions.net/proxyRequestV2/",r=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}),n=await r.json(),s=JSON.parse(n);return console.log(s),s}catch(e){console.error("kayn error ftchFirebase 115 : "+e)}}import{signOut,auth,onAuthStateChanged,signInWithCredential,GoogleAuthProvider,signInWithEmailAndPassword,db,ref,update,set,get,getDownloadURL,storageRef,storage}from"https://pricealerts.github.io/firebaseCode.js";window.handleCredentialResponse=(e=>{console.log("تم استلام التوكن...");const t=GoogleAuthProvider.credential(e.credential);signInWithCredential(auth,t).then(async e=>{let t=e.user;console.log("تم تسجيل الدخول بنجاح:",t),await updateUserData(t,!1),document.getElementById("buttonSignUp").style.display="none"}).catch(e=>{console.error("Error:",e)})}),window.onload=function(){google.accounts.id.initialize({client_id:"200237716010-fsre2cg3a1dgm666mb1qcq6gdhntl2sd.apps.googleusercontent.com",callback:handleCredentialResponse,auto_select:!1,cancel_on_tap_outside:!1,use_fedcm_for_logins:!0}),google.accounts.id.renderButton(document.getElementById("buttonSignUp"),{theme:"outline",size:"large",text:"signin_with",shape:"rectangular",width:"250"}),google.accounts.id.renderButton(document.getElementById("buttonSignIn"),{theme:"outline",size:"large",text:"signin_with",shape:"rectangular",width:"250"}),google.accounts.id.prompt(e=>{(e.isNotDisplayed()||e.isSkippedMoment())&&console.log("النافذة لم تظهر (ربما بسبب إغلاقها سابقاً أو إعدادات المتصفح)")})};let iLoup=0,isPrmrEntr=!0;onAuthStateChanged(auth,async e=>{e&&isPrmrEntr&&(gebi("imgNavbar").src="/imgs/web/apple-touch-icon.png",console.log("User is signed in:",e),await sgnOUt(e)),isPrmrEntr=!1}),console.log("hadi jdida 35"),gebi("frmSgnIn").addEventListener("submit",async e=>{e.preventDefault();const t=document.querySelectorAll("#frmSgnIn input");return userEmail=t[0].value,userPassword=t[1].value,userEmail.length&&userPassword.length?userPassword.length<6?(gebi("errmsgsgnIn").innerText=" كلمة المرور خاطئة ",gebi("errmsgsgnIn").style.color="red",!1):void await sgnIn("errmsgsgnIn"):(gebi("errmsgsgnIn").innerText="عليك ملأ البيانات",gebi("errmsgsgnIn").style.color="red",!1)}),gebi("msgCnfrmInEmail").addEventListener("submit",async e=>{e.preventDefault();const t=document.querySelectorAll("#msgCnfrmInEmail input");userEmail=t[0].value,gebi("errmsgCnfrmInEmail").innerText="جاري الإرسال...",gebi("errmsgCnfrmInEmail").style.color="black";try{const e=await ftchFirebase({action:"sndMsgCnferIn",userEmail:userEmail});if("notexsist"==e.status)return gebi("errmsgCnfrmInEmail").innerText="هذا الحساب غير موجود",gebi("errmsgCnfrmInEmail").style.color="red",setTimeout(()=>{activateSignUp()},2e3),!1;if("notsuccess"==e.status)return gebi("errmsgCnfrmInEmail").innerText="الإيمل خاطئ تأكد منه وأعد المحاولة",gebi("errmsgCnfrmInEmail").style.color="red",!1;"success"==e.status&&(gebi("msgCnfrmIn").style.transform="translateY(0%)",gebi("errmsgCnfrmInEmail").innerText="")}catch(e){return console.log("err rspnsCnfrm"+e),!1}}),gebi("msgCnfrmIn").addEventListener("submit",async e=>{e.preventDefault(),gebi("errmsgCnfrmIn").innerText="جاري التحقق ...",gebi("errmsgCnfrmIn").style.color="black";try{const e=await ftchFirebase({action:"cnfrmCode",userEmail:userEmail,inputCode:gebi("codeCnfrmIn").value,signUp:!1});return"overNmber"==e.status?(gebi("errmsgCnfrmIn").innerText="لقد قمت بالمحاولة أكثر من 4 مرات  أعد المحاولة بعد ساعة",gebi("errmsgCnfrmIn").style.color="red",!1):"notExist"==e.status?(gebi("errmsgCnfrmIn").innerText="رمز التحقق خاطئ أعد المحاولة",gebi("errmsgCnfrmIn").style.color="red",!1):"success"==e.status?(gebi("errmsgCnfrmIn").innerText="",gebi("newPswrd").style.transform="translateY(0%)",!1):(gebi("errmsgCnfrmIn").innerText="حدث خطأ أعد المحاولة ",gebi("errmsgCnfrmIn").style.color="red",!1)}catch(e){return console.log("error appscript : "+e),!1}}),gebi("newPswrd").addEventListener("submit",async e=>{e.preventDefault(),gebi("errNewPswrd").innerText="جاري التحديث ...",gebi("errNewPswrd").style.color="black",userPassword=gebi("inptNewPswrd").value;try{const e=await ftchFirebase({action:"updtPsw",userEmail:userEmail,userPassword:userPassword});"notExist"==e.status&&(gebi("errNewPswrd").innerText="إيميلك غير موجود أعد انشاء حساب من جديد",gebi("errNewPswrd").style.color="red",setTimeout(()=>{activateSignUp()},2e3)),"success"==e.status?await sgnIn("errmsgsgnIn"):(gebi("errmsgsgnIn").innerText="حدث خطأ أعد المحاولة ",gebi("errmsgsgnIn").style.color="red",console.error(e.status))}catch(e){return console.log("error btnNewPswrd : "+e),!1}});const lstLoclSrorge=["action","userId","userName","userEmail","userPassword","userPicture","chtId1","chtId2","chtId3","paid","base64Pctr"];for(let e=0;e<lstLoclSrorge.length;e++){const t=lstLoclSrorge[e];localStorage.removeItem(t)}const drction="../accont";gebi("frmSgnUp").addEventListener("submit",async e=>{e.preventDefault();const t=document.querySelectorAll("#frmSgnUp input");if(userName=t[0].value,userEmail=t[1].value,userPassword=t[2].value,!userName||!userEmail||!userPassword)return gebi("errmsgsgnUp").innerText="جميع الحقول مطلوبة",gebi("errmsgsgnUp").style.color="red",!1;if(userPassword.length<6)return gebi("errmsgsgnUp").innerText="كلمة المرور يجب أن تكون 6 رموز على الأقل",gebi("errmsgsgnUp").style.color="red",!1;gebi("errmsgsgnUp").innerText="جاري التسجيل ...",gebi("errmsgsgnUp").style.color="black";try{const e=await ftchFirebase({action:"sndMsgCnfer",userEmail:userEmail,userName:userName});if("exist"==e.status)return gebi("errmsgsgnUp").innerText="هذا الحساب موجود بالفعل قم بتسجيل الدخول",gebi("errmsgsgnUp").style.color="red",setTimeout(()=>{activateSignIn()},2e3),!1;"success"==e.status?gebi("msgCnfrm").style.transform="translateY(0%)":"notSend"==data.status?(gebi("errmsgsgnUp").innerText="الإيمل خاطئ تأكد منه وأعد المحاولة",gebi("errmsgsgnUp").style.color="red"):(gebi("errmsgsgnUp").innerText="حدث خطأ أعد المحاولة",gebi("errmsgsgnUp").style.color="red")}catch(e){return console.error("err rspnsCnfrm"+e),!1}}),gebi("msgCnfrm").addEventListener("submit",async e=>{e.preventDefault(),await adedUser()});