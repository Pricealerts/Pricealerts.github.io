function vrfInpts(e){e.addEventListener("input",()=>{const e=valInpts();e!=prmyrInpts||file?(gebi("saveBtn").style.backgroundColor="#007bff",gebi("saveBtn").style.cursor="pointer",isChnge=!0):(gebi("saveBtn").style.backgroundColor="#444",gebi("saveBtn").style.cursor="not-allowed",isChnge=!1)})}async function updateUserData(e){const t=ref(db,"users/"+userId);try{return await update(t,e),console.log("تم التسجيل وتعديل البيانات ✔️"),!0}catch(e){return console.error("حدث خطأ في التحديث:",e),gebi("rspns").innerText="حدث خطأ أعد المحاولة",gebi("rspns").style.color="red",!1}}function base64ToBlob(e){const t=e.split(","),i=t[0].match(/:(.*?);/)[1],n=atob(t[1]),s=[];for(let e=0;e<n.length;e++)s.push(n.charCodeAt(e));return new Blob([new Uint8Array(s)],{type:i})}function slctAll(e){return document.querySelectorAll(e)}function point(e){return e.touches?e.touches[0]:e}function distance(e,t){return Math.hypot(t.clientX-e.clientX,t.clientY-e.clientY)}function crop(){function e(e){const t=URL.createObjectURL(e);gebi("base64Pctr").src=t;const i=new FileReader;i.onloadend=function(){file=i.result},i.readAsDataURL(e),gebi("saveBtn").style.backgroundColor="#007bff",gebi("saveBtn").style.cursor="pointer",isChnge=!0}const t=circle.getBoundingClientRect(),i=image.getBoundingClientRect(),n=image.naturalWidth/image.width,s=t.width*n,r=(t.left-i.left)*n,c=(t.top-i.top)*n,a=700;canvas.width=a,canvas.height=a,ctx.clearRect(0,0,a,a),ctx.save(),ctx.beginPath(),ctx.arc(a/2,a/2,a/2,0,2*Math.PI),ctx.clip(),ctx.drawImage(image,r,c,s,s,0,0,a,a),ctx.restore();const o=100,l=.4,d=.95,g=1;let u=l,h=d,p=null;canvas.toBlob(t=>{function i(){if(h-u<.005)return void(p&&(e(p),console.log("الحجم النهائي:",Math.round(p.size/1024),"KB")));const t=(u+h)/2;canvas.toBlob(e=>{const n=e.size/1024;n>o+g?h=t:(u=t,p=e,console.log("محاولة:",Math.round(n),"KB")),i()},"image/jpeg",t)}const n=t.size/1024;if(n<=o)return e(t),void console.log("بدون ضغط:",Math.round(n),"KB");i()},"image/jpeg",d)}import{auth,onAuthStateChanged,db,ref,update,signOut,updateProfile,storage,storageRef,uploadBytes,getDownloadURL}from"https://pricealerts.github.io/firebaseCode.js";gebi("sgnOutInLink").addEventListener("click",async()=>{await onAuthStateChanged(auth,async e=>{if(e){const t=ref(db,"users/"+e.uid);await update(t,{lastLogout:(new Date).toISOString(),status:"outline"}),await signOut(auth)}localStorage.clear(),window.location.href="/signin"})});let userId,userBr,isChnge=!1;slctAll(".inptSave").forEach(e=>vrfInpts(e)),onAuthStateChanged(auth,async e=>{if(e){userBr=e,userId=e.uid;try{const t=ref(db,"users/"+e.uid);await get(t).then(async e=>{const t=e.exists();if(t){const{lastLogin:t,paid:i,status:n,...s}=e.val();for(const e in s)localStorage[e]=s[e];strtFunctn()}else console.log("is not")})}catch(e){}}else window.location.href="/signin"}),gebi("formSave").addEventListener("submit",async e=>{if(e.preventDefault(),!isChnge)return!1;if(gebi("rspns").innerText="جاري الحفظ ...",gebi("rspns").style.color="black",gebi("userName").innerText.length<2)return gebi("rspns").innerText="  خانة الإسم فارغة عليك ملأها ",gebi("rspns").style.color="red",setTimeout(()=>{gebi("rspns").innerText=""},15e3),!1;if(gebi("chtId1").value.length+gebi("chtId2").value.length+gebi("chtId3").value.length==0)return gebi("rspns").innerText="  لم تسجل أي chat Id ",gebi("rspns").style.color="red",setTimeout(()=>{gebi("rspns").innerText=""},5e3),!1;const t={userName:gebi("userName").innerText||"",chtId1:gebi("chtId1").value||"",chtId2:gebi("chtId2").value||"",chtId3:gebi("chtId3").value||""};if(file){if(!userBr)return alert("يجب تسجيل الدخول");const e=base64ToBlob(file),i=storageRef(storage,`avatars/${userBr.uid}`);await uploadBytes(i,e);const n=await getDownloadURL(i);await updateProfile(userBr,{photoURL:n}),console.log("تم تغيير الصورة بنجاح ✅"),t.userPicture="frbsStrg",localStorage.base64Pctr=file}for(const e in t)localStorage[e]!=t[e]&&(localStorage[e]=t[e]);try{t.userPicturec="";const e=await updateUserData(t);e&&(gebi("rspns").innerText="تم الحفظ بنجاح ✅",gebi("rspns").style.color="green",setTimeout(()=>{gebi("rspns").innerText="",window.location.href="https://pricealerts.web.app"},3e3))}catch(e){console.error("حدث خطأ في الرفع:",e),gebi("rspns").innerText="حدث خطأ أعد المحاولة",gebi("rspns").style.color="red"}file=null}),console.log("hadi jdida 8");const image=document.getElementById("imagePr"),circle=document.getElementById("cropCircle"),handle=document.getElementById("resizeHandle"),canvas=document.getElementById("result"),ctx=canvas.getContext("2d");let startX,startY,startSize,imgUrlSrc,file,dragging=!1,resizing=!1,startDist=null,hiding=()=>{setTimeout(()=>{gebi("divplac").className="dvPlc"},50),setTimeout(()=>{slctAll(".hidjs").forEach(e=>{e.style.display="none"})},450)};slctAll(".cler").forEach(e=>{e.addEventListener("click",hiding)}),gebi("divplac").addEventListener("click",e=>{e.stopPropagation()}),gebi("drop-area").addEventListener("click",e=>{file?(gebi("cntnr").style.display="block",gebi("divplac").classList.add("opPlc")):gebi("input-file").click()}),gebi("input-file").addEventListener("change",async e=>{if(file=e.target.files[0],!file)return;const t=new FileReader;gebi("cntnr").style.display="block",gebi("divplac").classList.add("opPlc"),t.onload=function(e){image.src=e.target.result,image.onload=function(){const e=image.width,t=image.height,i=e>t?t/2:e/2,n=i.toFixed(0),s=(t-n)/2;setTimeout(()=>{gebi("cropCircle").style.top=s+"px",gebi("cropCircle").style.left=`calc(50% - ${n/2}px)`,gebi("cropCircle").style.width=n+"px",gebi("cropCircle").style.height=n+"px"},100),image.hidden=!1}},t.readAsDataURL(file)}),circle.addEventListener("mousedown",e=>{e.target!==handle&&(dragging=!0,startX=e.clientX-circle.offsetLeft,startY=e.clientY-circle.offsetTop)}),document.addEventListener("mousemove",e=>{dragging&&(circle.style.left=e.clientX-startX+"px",circle.style.top=e.clientY-startY+"px")}),document.addEventListener("mouseup",()=>dragging=!1),handle.addEventListener("mousedown",e=>{e.stopPropagation(),resizing=!0,startX=e.clientX,startSize=circle.offsetWidth}),document.addEventListener("mousemove",e=>{if(!resizing)return;let t=startSize+(e.clientX-startX);t=Math.max(80,t),circle.style.width=circle.style.height=t+"px"}),document.addEventListener("mouseup",()=>resizing=!1),circle.addEventListener("touchstart",e=>{1===e.touches.length&&(dragging=!0,startX=e.touches[0].clientX-circle.offsetLeft,startY=e.touches[0].clientY-circle.offsetTop),2===e.touches.length&&(startDist=distance(e.touches[0],e.touches[1]),startSize=circle.offsetWidth)}),circle.addEventListener("touchmove",e=>{if(e.preventDefault(),1===e.touches.length&&dragging&&(circle.style.left=e.touches[0].clientX-startX+"px",circle.style.top=e.touches[0].clientY-startY+"px"),2===e.touches.length){let t=distance(e.touches[0],e.touches[1]),i=t/startDist,n=startSize*i;n=Math.max(80,n),circle.style.width=circle.style.height=n+"px"}}),circle.addEventListener("touchend",()=>{dragging=!1,startDist=null}),gebi("btnCrop").addEventListener("click",crop);