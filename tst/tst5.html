<!DOCTYPE html>
<html lang="ar">
	<head>
		<meta charset="UTF-8" />
		<title>ØªØ­ÙˆÙŠÙ„ ØµÙˆØ±Ø© Ø¥Ù„Ù‰ Base64</title>

		<style>
			body {
				font-family: Arial;
				text-align: center;
				padding: 20px;
			}
			img {
				margin-top: 20px;
				max-width: 90%;
				border: 1px solid #ccc;
			}
			textarea {
				width: 90%;
				height: 150px;
				margin-top: 20px;
			}
		</style>
	</head>

	<body>
		<h3>ØªØµØºÙŠØ± ØµÙˆØ±Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆØªØ­ÙˆÙŠÙ„Ù‡Ø§ Ø¥Ù„Ù‰ Base64</h3>

		<!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© -->
		<img
			id="sourceImg"
			alt="Google Drive Image"
			src="https://drive.google.com/thumbnail?id=1Swxr6FwLG3xFqOyyYs_xjxCkMzQUnFgz&sz=w800"
		/>
		<!-- 		https://drive.google.com/thumbnail?id=1Swxr6FwLG3xFqOyyYs_xjxCkMzQUnFgz&sz=w800 -->
		<br /><br />
		<button id="convertBtn">ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Base64</button>

		<br /><br />

		<!-- Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù†Ø§ØªØ¬Ø© -->
		<img id="outpotimg" />

		<!-- Ù†Øµ Base64 -->
		<textarea id="base64Output" placeholder="Ø³ÙŠØ¸Ù‡Ø± Ù‡Ù†Ø§ Base64"></textarea>

		<script>
			document.getElementById("convertBtn").addEventListener("click", () => {});

			function cmprsImg(params) {
				const img = document.getElementById("sourceImg");

				if (!img.complete) {
					alert("Ø§Ù„ØµÙˆØ±Ø© Ù„Ù… ØªÙØ­Ù…Ù‘Ù„ Ø¨Ø¹Ø¯");
					return;
				}

				const canvas = document.createElement("canvas");
				const ctx = canvas.getContext("2d");

				// 1ï¸âƒ£ ØªØµØºÙŠØ± Ø§Ù„Ø£Ø¨Ø¹Ø§Ø¯
				const MAX_WIDTH = 1200;
				let width = img.naturalWidth;
				let height = img.naturalHeight;

				if (width > MAX_WIDTH) {
					height = height * (MAX_WIDTH / width);
					width = MAX_WIDTH;
				}

				canvas.width = width;
				canvas.height = height;
				ctx.drawImage(img, 0, 0, width, height);

				// 2ï¸âƒ£ ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Base64 Ù…Ø¹ Ø¶ØºØ·
				let quality = 0.9;
				let base64;

				do {
					base64 = canvas.toDataURL("image/jpeg", quality);
					quality -= 0.05;
				} while (base64.length > 50 * 1024 * 1.37 && quality > 0.1);
				// 1.37 ØªÙ‚Ø±ÙŠØ¨ Ù„ØªØ­ÙˆÙŠÙ„ Base64 Ø¥Ù„Ù‰ Ø­Ø¬Ù… ÙØ¹Ù„ÙŠ

				// Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø©
				document.getElementById("outpotimg").src = base64;

				// Ø¹Ø±Ø¶ Ø§Ù„Ù†Øµ
				document.getElementById("base64Output").value = base64;

				console.log("Base64 length:", base64.length);
			}
		</script>

		<script>
			function crop() {
				const rect = circle.getBoundingClientRect();
				const imgRect = image.getBoundingClientRect();

				const scaleX = image.naturalWidth / image.width;

				const srcSize = rect.width * scaleX;
				const srcX = (rect.left - imgRect.left) * scaleX;
				const srcY = (rect.top - imgRect.top) * scaleX;

				// Ø­Ø¬Ù… Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
				const OUTPUT_SIZE = 500;

				canvas.width = OUTPUT_SIZE;
				canvas.height = OUTPUT_SIZE;

				ctx.clearRect(0, 0, OUTPUT_SIZE, OUTPUT_SIZE);

				// Ù‚Øµ Ø¯Ø§Ø¦Ø±ÙŠ
				ctx.save();
				ctx.beginPath();
				ctx.arc(
					OUTPUT_SIZE / 2,
					OUTPUT_SIZE / 2,
					OUTPUT_SIZE / 2,
					0,
					Math.PI * 2
				);
				ctx.clip();

				ctx.drawImage(
					image,
					srcX,
					srcY,
					srcSize,
					srcSize,
					0,
					0,
					OUTPUT_SIZE,
					OUTPUT_SIZE
				);

				ctx.restore();

				/* ===============================
	   Ø¶ØºØ· Ø§Ù„ØµÙˆØ±Ø© â‰ˆ 100KB Ø¨Ø£Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø©
	================================ */

				const TARGET_KB = 100;
				const MIN_QUALITY = 0.4;
				const MAX_QUALITY = 0.95;
				const TOLERANCE = 1;

				let minQ = MIN_QUALITY;
				let maxQ = MAX_QUALITY;
				let bestBlob = null;

				function compress() {
					if (maxQ - minQ < 0.005) {
						if (bestBlob) {
							const url = URL.createObjectURL(bestBlob);
							document.getElementById("uploadedImage").src = url;

							console.log(
								"Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ:",
								Math.round(bestBlob.size / 1024),
								"KB"
							);

							// ğŸ”¹ ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Base64
							const reader = new FileReader();
							reader.onloadend = function () {
								const base64 = reader.result;
								console.log("Base64:");
								console.log(base64);
							};
							reader.readAsDataURL(bestBlob);
						}
						return;
					}

					const q = (minQ + maxQ) / 2;

					canvas.toBlob(
						blob => {
							const sizeKB = blob.size / 1024;
							if (sizeKB > TARGET_KB + TOLERANCE) {
								maxQ = q;
							} else {
								minQ = q;
								bestBlob = blob;
							}
							compress();
						},
						"image/jpeg",
						q
					);
				}
				compress();
			}
			const url =
				"https://lh3.googleusercontent.com/a/ACg8ocIjyWfbbXlsfUWR9x-fkKLDgnKFiO2j0IxnO0z89s2ThPc8nvKoPA=s500-c";

			const index = url.lastIndexOf("=") + 1;

			const newUrl = index !== -1 ? url.substring(0, index) + "s700-c" : url;

			console.log(newUrl);
		</script>
	</body>
</html>
